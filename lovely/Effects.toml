[manifest]
version = "1.0.0"
dump_lua = true
priority = -1

# Locked Stuff
[[patches]]
[patches.pattern]
target = "functions/common_events.lua"
pattern = "'            elseif _c.name == 'Bootstraps' then loc_vars = {_c.unlock_condition.extra.count}'"
position = "after"
payload = "'            elseif _c.name == 'Querent' then loc_vars = {_c.unlock_condition.extra}'"
match_indent = false

[[patches]]
[patches.pattern]
target = "functions/common_events.lua"
pattern = '''            elseif _c.name == 'Overstock Plus' then loc_vars = {_c.unlock_condition.extra, G.PROFILES[G.SETTINGS.profile].career_stats.c_shop_dollars_spent}'''
position = "after"
payload = '''            elseif _c.name == "Collector Booster" then loc_vars = {_c.unlock_condition.extra, G.PROFILES[G.SETTINGS.profile].career_stats.c_shop_dollars_spent}'''
match_indent = false

[[patches]]
[patches.pattern]
target = "tag.lua"
pattern = '''                elseif self.name == 'Polychrome Tag' then
                    _context.card.temp_edition = true
                    self:yep('+', G.C.DARK_EDITION,function() 
                        _context.card.temp_edition = nil
                        _context.card:set_edition({polychrome = true}, true)
                        _context.card.ability.couponed = true
                        _context.card:set_cost()
                        G.CONTROLLER.locks[lock] = nil
                        return true
                    end)
                    _applied = true'''
position = "after"
payload = '''                elseif self.name == 'Gilded Tag' then
                    _context.card.temp_edition = true
                    self:yep('+', G.C.DARK_EDITION,function() 
                        _context.card.temp_edition = nil
                        _context.card:set_edition({BCU_gilded = true}, true)
                        _context.card.ability.couponed = true
                        _context.card:set_cost()
                        G.CONTROLLER.locks[lock] = nil
                        return true
                    end)
                    _applied = true'''
match_indent = false










[[patches]]
[patches.pattern]
target = "functions/common_events.lua"
pattern = '''                if card.unlock_condition.planet_count then 
                    if #G.P_CENTER_POOLS.Planet <= args.planet_count then
                        ret = true
                        unlock_card(card)
                    end
                end'''
position = "after"
payload = '''                if card.unlock_condition.spectral_count then 
                    if #G.P_CENTER_POOLS.Spectral <= args.spectral_count then
                        ret = true
                        unlock_card(card)
                    end
                end'''
match_indent = false

[[patches]]
[patches.pattern]
target = "functions/common_events.lua"
pattern = '''                if card.name == 'Golden Ticket' then 
                    local tally = 0
                    for j = 1, #args.cards do
                        if SMODS.has_enhancement(args.cards[j], 'm_gold') then
                            tally = tally+1
                        end
                    end
                    if tally >= 5 then 
                        ret = true
                        unlock_card(card)
                    end
                end'''
position = "after"
payload = '''                if card.name == 'Superstition' then 
                    local tally = 0
                    for j = 1, #args.cards do
                        if args.cards[j]:get_id() == 7 and SMODS.has_enhancement(args.cards[j], 'm_lucky') then
                            tally = tally+1
                        end
                    end
                    if tally >= 3 then 
                        ret = true
                        unlock_card(card)
                    end
                end
                '''
match_indent = false

[[patches]]
[patches.pattern]
target = "functions/common_events.lua"
pattern = '''if card.unlock_condition.extra and card.unlock_condition.extra.tally then
                    local count = 0
                    for _, v in pairs(G.playing_cards) do
                        if v.ability.set == 'Enhanced' then count = count + 1 end
                    end
                    if count >= card.unlock_condition.extra.count then
                        ret = true
                        unlock_card(card)
                    end
                end'''
position = "after"
payload = '''                if card.unlock_condition.extra and card.unlock_condition.extra.proxy then
                    local count = 0
                    for _, v in pairs(G.playing_cards) do
                        if v.ability.set == 'Enhanced' or v.ability.set ~= 'Enhanced' then count = count + 1 end
                    end
                    if count >= card.unlock_condition.extra.count then
                        ret = true
                        unlock_card(card)
                    end
                end'''
match_indent = false






[[patches]]
[patches.pattern]
target = "functions/misc_functions.lua"
pattern = '''  if check_for_unlock then check_for_unlock({type = 'discover_amount',
        amount = G.DISCOVER_TALLIES.total.tally,
        planet_count = G.DISCOVER_TALLIES.planets.tally,
        tarot_count = G.DISCOVER_TALLIES.tarots.tally})
  end'''
position = "at"
payload = '''  if check_for_unlock then check_for_unlock({type = 'discover_amount',
        amount = G.DISCOVER_TALLIES.total.tally,
        planet_count = G.DISCOVER_TALLIES.planets.tally,
        tarot_count = G.DISCOVER_TALLIES.tarots.tally,
        spectral_count = G.DISCOVER_TALLIES.spectrals.tally})
  end'''
match_indent = false

[[patches]]
[patches.pattern]
target = "functions/common_events.lua"
pattern = '''       elseif _c.name == "The Wheel of Fortune" then loc_vars = {G.GAME.probabilities.normal, cfg.extra};  info_queue[#info_queue+1] = G.P_CENTERS.e_foil; info_queue[#info_queue+1] = G.P_CENTERS.e_holo; info_queue[#info_queue+1] = G.P_CENTERS.e_polychrome; '''
position = "at"
payload = '''       elseif _c.name == "The Wheel of Fortune" then loc_vars = {G.GAME.probabilities.normal, cfg.extra};  info_queue[#info_queue+1] = G.P_CENTERS.e_foil; info_queue[#info_queue+1] = G.P_CENTERS.e_holo; info_queue[#info_queue+1] = G.P_CENTERS.e_polychrome; info_queue[#info_queue+1] = G.P_CENTERS.e_BCU_gilded; '''
match_indent = false

[[patches]]
[patches.pattern]
target = "functions/common_events.lua"
pattern = '''        if _c.name == 'Aura' then
            info_queue[#info_queue+1] = G.P_CENTERS.e_foil
            info_queue[#info_queue+1] = G.P_CENTERS.e_holo
            info_queue[#info_queue+1] = G.P_CENTERS.e_polychrome
        end'''
position = "at"
payload = '''        if _c.name == 'Aura' then
            info_queue[#info_queue+1] = G.P_CENTERS.e_foil
            info_queue[#info_queue+1] = G.P_CENTERS.e_holo
            info_queue[#info_queue+1] = G.P_CENTERS.e_polychrome
            info_queue[#info_queue+1] = G.P_CENTERS.e_BCU_gilded
        end'''
match_indent = false



# Deck stuff
[[patches]]
[patches.pattern]
target = "back.lua"
pattern = '''elseif name_to_check == 'Plasma Deck' then loc_args = {effect_config.ante_scaling}'''
position = "at"
payload = '''elseif name_to_check == 'Plasma Deck' then loc_args = {effect_config.ante_scaling}
elseif name_to_check == 'Travel Deck' then loc_args = {effect_config.ante_scaling}
'''
match_indent = false

       
[[patches]]
[patches.pattern]
target = "card.lua"
pattern = '''                if self.ability.name == 'Hanging Chad' and (
                context.other_card == context.scoring_hand[1]) then
                    return {
                        message = localize('k_again_ex'),
                        repetitions = self.ability.extra,
                        card = self
                    }
                end'''
position = "after"
payload = '''                        if self.ability.name == 'Hat Trick' and G.GAME.hands[context.scoring_name] and G.GAME.hands[context.scoring_name].played_this_round > 2 then
                    return {
                        message = localize('k_again_ex'),
                        repetitions = self.ability.extra,
                        card = self
                    }
                end'''
match_indent = false


       
[[patches]]
[patches.pattern]
target = "card.lua"
pattern = '''            local edition = poll_edition('aura', nil, true, true)'''
position = "at"
payload = '''            local edition = poll_edition('aura', nil, true, true, {'e_foil', 'e_holo', 'e_polychrome', 'e_BCU_gilded'})'''
match_indent = false

[[patches]]
[patches.pattern]
target = "card.lua"
pattern = '''                    edition = poll_edition('wheel_of_fortune', nil, true, true)'''
position = "at"
payload = '''                    edition = poll_edition('wheel_of_fortune', nil, true, true, {'e_foil', 'e_holo', 'e_polychrome', 'e_BCU_gilded'})'''
match_indent = false






[[patches]]
[patches.pattern]
target = "card.lua"
pattern = '''    end    if center_table.name == 'Overstock' or center_table.name == 'Overstock Plus' then
        G.E_MANAGER:add_event(Event({func = function()
            change_shop_size(1)
            return true end }))
    end'''
position = "after"
payload = '''if center_table.name == 'Draft Booster' or center_table.name == 'Collector Booster' then
        G.E_MANAGER:add_event(Event({func = function()
            SMODS.change_booster_limit(1)
            return true end }))
    end'''
match_indent = false


[[patches]]
[patches.pattern]
target = "functions/common_events.lua"
pattern = '''function change_shop_size(mod)
    if not G.GAME.shop then return end
    G.GAME.shop.joker_max = G.GAME.shop.joker_max + mod
    if G.shop_jokers and G.shop_jokers.cards then
        if mod < 0 then
            --Remove jokers in shop
            for i = #G.shop_jokers.cards, G.GAME.shop.joker_max+1, -1 do
                if G.shop_jokers.cards[i] then
                    G.shop_jokers.cards[i]:remove()
                end
            end
        end
        G.shop_jokers.config.card_limit = G.GAME.shop.joker_max
        G.shop_jokers.T.w = math.min(G.GAME.shop.joker_max*1.02*G.CARD_W,4.08*G.CARD_W)
        G.shop:recalculate()
        if mod > 0 then
            for i = 1, G.GAME.shop.joker_max - #G.shop_jokers.cards do
                G.shop_jokers:emplace(create_card_for_shop(G.shop_jokers))
            end
        end
    end
end'''
position = "after"
payload = '''function change_booster_size(mod)
    if not G.GAME.shop then return end
    if not G.GAME.modifiers.extra_boosters then
        G.GAME.modifiers.extra_boosters = 0
    end
    G.GAME.modifiers.extra_boosters = G.GAME.modifiers.extra_boosters + mod
    G.shop:recalculate()
end'''
match_indent = false


[[patches]]
[patches.pattern]
target = "card.lua"
pattern = '''if self.ability.name == 'Fortune Teller' and not context.blueprint and (context.consumeable.ability.set == "Tarot") then'''
position = "before"
payload = '''
            if self.ability.name == 'Fortune Cookie' and not context.blueprint and context.consumeable.ability.set == 'Spectral'  then
                if #G.consumeables.cards + G.GAME.consumeable_buffer < G.consumeables.config.card_limit then
                    G.GAME.consumeable_buffer = G.GAME.consumeable_buffer + 1
                    G.E_MANAGER:add_event(Event({
                        trigger = 'before',
                        delay = 0.0,
                        func = (function()
                                local card = create_card('Spectral',G.consumeables, nil, nil, nil, nil, nil, 'fortune_cookie')
                                card:add_to_deck()
                                G.consumeables:emplace(card)
                                G.GAME.consumeable_buffer = 0
                            return true
                        end)}))
                    card_eval_status_text(context.blueprint_card or self, 'extra', nil, nil, nil, {message = localize('k_plus_spectral'), colour = G.C.SECONDARY_SET.Spectral})
                    if self.ability.extra.uses_left - 1 <= 0 then 
                        G.E_MANAGER:add_event(Event({
                            func = function()
                                play_sound('tarot1')
                                self.T.r = -0.2
                                self:juice_up(0.3, 0.4)
                                self.states.drag.is = true
                                self.children.center.pinch.x = true
                                G.E_MANAGER:add_event(Event({trigger = 'after', delay = 0.3, blockable = false,
                                    func = function()
                                            G.jokers:remove_card(self)
                                            self:remove()
                                            self = nil
                                        return true; end})) 
                                return true
                            end
                        })) 
                        return {
                            message = "Eat",
                            colour = G.C.FILTER
                        }
                    else
                        self.ability.extra.uses_left = self.ability.extra.uses_left - 1
                        return {
                            message = self.ability.extra.uses_left..'',
                            colour = G.C.FILTER
                        }
                    end
                end
               return true
            end'''
match_indent = true


       
# Joker Variables
[[patches]]
[patches.pattern]
target = "card.lua"
pattern = '''        elseif self.ability.name == 'Yorick' then loc_vars = {self.ability.extra.xmult, self.ability.extra.discards, self.ability.yorick_discards, self.ability.x_mult}
'''
position = "after"
payload = '''        elseif self.ability.name == 'Quin' then loc_vars = {self.ability.extra.xmult_gain, self.ability.extra.gold_cards, self.ability.extra.quin_cards, self.ability.x_mult}
elseif self.ability.name == 'Middle Of The Pack' then loc_vars = {self.ability.extra}
elseif self.ability.name == 'Fortune Cookie' then loc_vars = {self.ability.extra.uses_left}
elseif self.ability.name == 'Office Cubicle' then loc_vars = {self.ability.extra.dollars}
elseif self.ability.name == 'Hat Trick' then loc_vars = {self.ability.extra}
              elseif self.ability.name == 'Coloring Page' then
                    local mostsuit = "nil"
                    if G.deck then
                        local suittable = {}
                        local amount = 0
                        for suit, v in pairs(SMODS.Suits) do
                            for i = 1, #G.deck.cards do
                                if G.deck.cards[i].base.suit == suit then
                                    amount = amount + 1
                                end
                            end
                            suittable[suit] = amount 
                            amount = 0   
                        end
                        local oldsuit = 0
                        local newsuit = 0
                        for suit, v in pairs(suittable) do
                            newsuit = v 
                            if newsuit > oldsuit then
                                oldsuit = newsuit
                                mostsuit = suit
                            end
                        end
                    else
                        mostsuit = "N/A"
                    end
                    loc_vars = {mostsuit}
'''
match_indent = true


[[patches]]
[patches.pattern]
target = "card.lua"
pattern = '''        elseif self.ability.name == 'Satellite' then
            local planets_used = 0
            for k, v in pairs(G.GAME.consumeable_usage) do if v.set == 'Planet' then planets_used = planets_used + 1 end end
            loc_vars = {self.ability.extra, planets_used*self.ability.extra}'''
position = "after"
payload = '''
        elseif self.ability.name == 'Querent' then
            local tarots_used = 0
            for k, v in pairs(G.GAME.consumeable_usage) do if v.set == 'Tarot' then tarots_used = tarots_used + 1 end end
            loc_vars = {self.ability.extra, tarots_used*self.ability.extra}'''
match_indent = true

[[patches]]
[patches.pattern]
target = "card.lua"
pattern = '''if self.ability.name == 'Burnt Joker' and G.GAME.current_round.discards_used <= 0 and not context.hook then'''
position = "before"
payload = '''            if self.ability.name == "Coloring Page" and #context.full_hand == 1 and not context.hook then
                local suittable = {}
                local amount = 0
                for suit, v in pairs(SMODS.Suits) do
                    for i = 1, #G.deck.cards do
                        if G.deck.cards[i].base.suit == suit then
                            amount = amount + 1
                        end
                    end
                    suittable[suit] = amount 
                    amount = 0   
                end
                local oldsuit = 0
                local newsuit = 0
                local mostsuit = "nil"
                for suit, v in pairs(suittable) do
                    newsuit = v 
                    if newsuit > oldsuit then
                        oldsuit = newsuit
                        mostsuit = suit
                    end
                end
                for i = 1, #G.deck.cards do   
                    if G.deck.cards[i].base.suit == mostsuit then
                        local _card = G.deck.cards[i]
                        draw_card(G.deck,G.hand, 20, nil, true, _card)
                        return true
                    end
                end
            end'''
match_indent = false

[[patches]]
[patches.pattern]
target = "functions/misc_functions.lua"
pattern = '''      if card.config.center.set == 'Tarot' or card.config.center.set == 'Planet' then'''
position = "at"
payload = '''if card.config.center.set == 'Tarot' or card.config.center.set == 'Planet' or (card.config.center.set == 'Spectral' and next(find_joker('Scryer'))) then'''
match_indent = true

[[patches]]
[patches.pattern]
target = "card.lua"
pattern = '''    if self.ability.name == 'The Emperor' or self.ability.name == 'The High Priestess' then
        for i = 1, math.min((self.ability.consumeable.tarots or self.ability.consumeable.planets), G.consumeables.config.card_limit - #G.consumeables.cards) do
            G.E_MANAGER:add_event(Event({trigger = 'after', delay = 0.4, func = function()
                if G.consumeables.config.card_limit > #G.consumeables.cards then
                    play_sound('timpani')
                    local card = create_card((self.ability.name == 'The Emperor' and 'Tarot') or (self.ability.name == 'The High Priestess' and 'Planet'), G.consumeables, nil, nil, nil, nil, nil, (self.ability.name == 'The Emperor' and 'emp') or (self.ability.name == 'The High Priestess' and 'pri'))
                    card:add_to_deck()
                    G.consumeables:emplace(card)
                    used_tarot:juice_up(0.3, 0.5)
                end
                return true end }))
        end
        delay(0.6)
    end'''
position = "at"
payload = '''    if self.ability.name == 'The Emperor' or self.ability.name == 'The High Priestess' then
        if next(find_joker('Scryer')) then
            for i = 1, math.min(((self.ability.consumeable.tarots or self.ability.consumeable.spectrals) or self.ability.consumeable.planets), G.consumeables.config.card_limit - #G.consumeables.cards) do
                G.E_MANAGER:add_event(Event({trigger = 'after', delay = 0.4, func = function()
                    local scry_decide = pseudorandom(pseudoseed("scry_decide"))
                    local scry_consume = "Tarot"
                    if scry_decide > 0.5 then
                        scry_consume = "Spectral"
                    else
                        scry_consume = "Tarot"
                    end

                    if G.consumeables.config.card_limit > #G.consumeables.cards then
                            play_sound('timpani')
                            local card = create_card((self.ability.name == 'The Emperor' and (scry_consume)) or (self.ability.name == 'The High Priestess' and 'Planet'), G.consumeables, nil, nil, nil, nil, nil, (self.ability.name == 'The Emperor' and 'emp') or (self.ability.name == 'The High Priestess' and 'pri'))
                            card:add_to_deck()
                            G.consumeables:emplace(card)
                            used_tarot:juice_up(0.3, 0.5)
                    end
                    return true end }))
            end
        else
            for i = 1, math.min((self.ability.consumeable.tarots or self.ability.consumeable.planets), G.consumeables.config.card_limit - #G.consumeables.cards) do
                G.E_MANAGER:add_event(Event({trigger = 'after', delay = 0.4, func = function()
                    if G.consumeables.config.card_limit > #G.consumeables.cards then
                        play_sound('timpani')
                        local card = create_card((self.ability.name == 'The Emperor' and 'Tarot') or (self.ability.name == 'The High Priestess' and 'Planet'), G.consumeables, nil, nil, nil, nil, nil, (self.ability.name == 'The Emperor' and 'emp') or (self.ability.name == 'The High Priestess' and 'pri'))
                        card:add_to_deck()
                        G.consumeables:emplace(card)
                        used_tarot:juice_up(0.3, 0.5)
                    end
                    return true end }))
            end
        end
        delay(0.6)
    end'''
match_indent = true








[[patches]]
[patches.pattern]
target = "card.lua"
pattern = '''        elseif context.skip_blind then
            if self.ability.name == 'Throwback' and not context.blueprint then
                G.E_MANAGER:add_event(Event({
                    func = function() 
                        card_eval_status_text(self, 'extra', nil, nil, nil, {
                            message = localize{type = 'variable', key = 'a_xmult', vars = {self.ability.x_mult}},
                                colour = G.C.RED,
                            card = self
                        }) 
                        return true
                    end}))
                return nil, true
            end'''
position = "at"
payload = '''        elseif context.skip_blind then
    if self.ability.name == 'Throwback' and not context.blueprint then
        G.E_MANAGER:add_event(Event({
            func = function() 
                card_eval_status_text(self, 'extra', nil, nil, nil, {
                    message = localize{type = 'variable', key = 'a_xmult', vars = {self.ability.x_mult}},
                    colour = G.C.RED,
                    card = self
                }) 
                return true
            end
        }))
        return nil, true
    elseif self.ability.name == 'Sticker Sheet' then
        G.E_MANAGER:add_event(Event({
            func = function()
                for i = 1, 1 do
                    local tag = Tag(get_next_tag_key("StickerSheet"))
                    if tag.name == "Orbital Tag" then
                        local _poker_hands = {}
                        for k, v in pairs(G.GAME.hands) do
                            if v.visible then
                                _poker_hands[#_poker_hands + 1] = k
                            end
                        end
                        tag.ability.orbital_hand = pseudorandom_element(_poker_hands, pseudoseed("StickerSheet"))
                    end
                    add_tag(tag)
                    play_sound('generic1', 0.9 + math.random()*0.1, 0.8)
                end
                return true
            end
        }))
        return nil, true
    end'''
match_indent = true

[[patches]]
[patches.pattern]
target = "card.lua"
pattern = '''                        if self.ability.name == 'Joker' then
                            return {
                                message = localize{type='variable',key='a_mult',vars={self.ability.mult}},
                                mult_mod = self.ability.mult
                            }
                        end'''
position = "after"
payload = '''
    if self.ability.name == 'The Scales' then
        local Scales_tot = hand_chips + mult
		hand_chips = mod_chips(math.floor(Scales_tot / 2))
		mult = mod_mult(math.floor(Scales_tot / 2))
        update_hand_text({delay = 0}, {mult = mult, chips = hand_chips})

        G.E_MANAGER:add_event(Event({
            func = (function()
                self:juice_up()
                local text = localize('k_balanced')
                play_sound('gong', 0.94, 0.3)
                play_sound('gong', 0.94*1.5, 0.2)
                play_sound('tarot1', 1.5)
                ease_colour(G.C.UI_CHIPS, {0.8, 0.45, 0.85, 1})
                ease_colour(G.C.UI_MULT, {0.8, 0.45, 0.85, 1})
                attention_text({
                    scale = 1.4, text = text, hold = 2, align = 'cm', offset = {x = 0,y = -2.7},major = G.play
                })
                G.E_MANAGER:add_event(Event({
                    trigger = 'after',
                    blockable = false,
                    blocking = false,
                    delay =  4.3,
                    func = (function() 
                            ease_colour(G.C.UI_CHIPS, G.C.BLUE, 2)
                            ease_colour(G.C.UI_MULT, G.C.RED, 2)
                        return true
                    end)
                }))
                G.E_MANAGER:add_event(Event({
                    trigger = 'after',
                    blockable = false,
                    blocking = false,
                    no_delete = true,
                    delay =  6.3,
                    func = (function() 
                        G.C.UI_CHIPS[1], G.C.UI_CHIPS[2], G.C.UI_CHIPS[3], G.C.UI_CHIPS[4] = G.C.BLUE[1], G.C.BLUE[2], G.C.BLUE[3], G.C.BLUE[4]
                        G.C.UI_MULT[1], G.C.UI_MULT[2], G.C.UI_MULT[3], G.C.UI_MULT[4] = G.C.RED[1], G.C.RED[2], G.C.RED[3], G.C.RED[4]
                        return true
                    end)
                }))
                return true
            end)
        }))

        delay(0.6)
        return scale_chips, scale_mult
    end'''
match_indent = false

[[patches]]
[patches.pattern]
target = "card.lua"
pattern = '''                if self.ability.name == 'Fibonacci' and (
                context.other_card:get_id() == 2 or 
                context.other_card:get_id() == 3 or 
                context.other_card:get_id() == 5 or 
                context.other_card:get_id() == 8 or 
                context.other_card:get_id() == 14) then
                    return {
                        mult = self.ability.extra,
                        card = self
                    }
                end'''
position = "after"
payload = '''
            if self.ability.name == 'Middle Of The Pack' and (
            context.other_card:get_id() == 4 or 
            context.other_card:get_id() == 5 or 
            context.other_card:get_id() == 6 or 
            context.other_card:get_id() == 7) then
                return {
                    mult = self.ability.extra,
                    card = self
                }
            end
            if self.ability.name == 'Office Cubicle' and (
            context.other_card:get_id() == 9 or 
            context.other_card:get_id() == 2 or 
            context.other_card:get_id() == 5) then
                return {
                    dollars = self.ability.extra.dollars,
                    card = self
                }
            end
    
    if self.ability.name == 'Quin' and SMODS.has_enhancement(context.other_card, 'm_gold') and context.individual and not context.blueprint then
        self.ability.extra.quin_cards = self.ability.extra.quin_cards + 1
        if self.ability.extra.quin_cards == self.ability.extra.gold_cards then
            self.ability.x_mult = self.ability.x_mult + self.ability.extra.xmult_gain
            self.ability.extra.quin_cards = 0
            card_eval_status_text(self, 'extra', nil, nil, nil, {
                message = localize{type='variable', key='a_xmult', vars={self.ability.x_mult}},
                colour = G.C.RED
            })
        end
end'''
match_indent = false




[[patches]]
[patches.pattern]
target = "card.lua"
pattern = '''                if self.ability.name == 'Egg' then
                    self.ability.extra_value = self.ability.extra_value + self.ability.extra
                    self:set_cost()
                    return {
                        message = localize('k_val_up'),
                        colour = G.C.MONEY
                    }
                end'''
position = "after"
payload = '''                if self.ability.name == 'Joker Proxy' then
                local proxy_pool = {}
                for k, v in pairs(G.P_CENTER_POOLS["Enhanced"]) do
                    proxy_pool[#proxy_pool+1] = v
                end
                local _card = create_playing_card({
                    front = pseudorandom_element(G.P_CARDS, pseudoseed('proxy_joker')),
                    center = pseudorandom_element(G.P_CENTER_POOLS["Enhanced"], pseudoseed('proxy_joker'))
                    }, G.discard, true, nil, {G.C.SECONDARY_SET.Enhanced}, true)
                _card:set_seal(SMODS.poll_seal({guaranteed = true, type_key = 'proxy_joker'}))
                G.E_MANAGER:add_event(Event({
                    func = function()
                        G.deck:emplace(_card)
                        _card:start_materialize()
                        G.deck.config.card_limit = G.deck.config.card_limit + 1
                        if context_blueprint_card then context_blueprint_card:juice_up() else self:juice_up() end
                        return true
                    end}))
                playing_card_joker_effects({_card})
                
                return nil, true

end'''
match_indent = false







# Joker Effects
[[patches]]
[patches.pattern]
target = "card.lua"
pattern = '''                        if self.ability.name == 'Mystic Summit' and G.GAME.current_round.discards_left == self.ability.extra.d_remaining then
                            return {
                                message = localize{type='variable',key='a_mult',vars={self.ability.extra.mult}},
                                mult_mod = self.ability.extra.mult
                            }
                        end'''
position = "after"
payload = '''                        if self.ability.name == 'Superstition' then
                            G.E_MANAGER:add_event(Event({
                                trigger = 'after',
                                delay = 0.15,
                                func = function()
                                    if #G.hand.cards and #G.hand.cards >= 1 then
                                        local destroyed_cards = {}
                                        for i=1, #G.hand.cards do
                                            if G.hand.cards[i]:get_id() == 13 then
                                                table.insert(destroyed_cards, G.hand.cards[i])  
                                            end
                                        end
                                        if #destroyed_cards > 0 then
                                            G.E_MANAGER:add_event(Event({
                                            trigger = 'after',
                                            delay = 0.15,
                                            func = function()
                                            just_destroy_cards(destroyed_cards)
                                            return true end}))
                                            card_eval_status_text(self, 'extra', nil, nil, nil, {
                                                message = localize('k_superstitiondestroy'),
                                                colour = G.C.RED}
                                                )
                                        end
                                    end
                                    return true
                                end}))
                        end'''
match_indent = false


[[patches]]
[patches.pattern]
target = "card.lua"
pattern = '''                    if self.ability.name == 'Midas Mask' and not context.blueprint then
                        local faces = {}
                        for k, v in ipairs(context.scoring_hand) do
                            if v:is_face() then 
                                faces[#faces+1] = v
                                v:set_ability(G.P_CENTERS.m_gold, nil, true)
                                G.E_MANAGER:add_event(Event({
                                    func = function()
                                        v:juice_up()
                                        return true
                                    end
                                })) 
                            end
                        end
                        if #faces > 0 then 
                            return {
                                message = localize('k_gold'),
                                colour = G.C.MONEY,
                                card = self
                            }
                        end
                    end'''
position = "after"
payload = '''                    if self.ability.name == 'Superstition' and not context.blueprint then
                        local sevens = {}
                        for k, v in ipairs(context.scoring_hand) do
                            if v:get_id() == 7 then 
                                sevens[#sevens+1] = v
                                v:set_ability(G.P_CENTERS.m_lucky, nil, true)
                                G.E_MANAGER:add_event(Event({
                                    func = function()
                                        v:juice_up()
                                        return true
                                    end
                                })) 
                            end
                        end
                        if #sevens > 0 then 
                            return {
                                message = localize('k_lucky'),
                                colour = G.C.GREEN,
                                card = self
                            }
                        end
                    end'''
match_indent = true

[[patches]]
[patches.pattern]
target = "card.lua"
pattern = '''if self.ability.name == 'Satellite' then 
            local planets_used = 0
            for k, v in pairs(G.GAME.consumeable_usage) do
                if v.set == 'Planet' then planets_used = planets_used + 1 end
            end
            if planets_used == 0 then return end
            return self.ability.extra*planets_used
        end'''
position = "after"
payload = '''if self.ability.name == 'Querent' then 
            local tarots_used = 0
            for k, v in pairs(G.GAME.consumeable_usage) do
                if v.set == 'Tarot' then tarots_used = tarots_used + 1 end
            end
            if tarots_used == 0 then return end
            return self.ability.extra*tarots_used
        end'''
match_indent = true

# Pelter Jokers
[[patches]]
[patches.pattern]
target = "card.lua"
pattern = '''        elseif self.ability.name == 'The Duo' or self.ability.name == 'The Trio'
            or self.ability.name == 'The Family' or self.ability.name == 'The Order' or self.ability.name == 'The Tribe' then loc_vars = {self.ability.x_mult, localize(self.ability.type, 'poker_hands')}'''
position = "at"
payload = '''        elseif self.ability.name == 'The Duo' or self.ability.name == 'The Trio'
            or self.ability.name == 'The Family' or self.ability.name == 'The Quarrel' or self.ability.name == 'The Order' or self.ability.name == 'The Tribe' then loc_vars = {self.ability.x_mult, localize(self.ability.type, 'poker_hands')}'''
match_indent = false

[[patches]]
[patches.pattern]
target = "functions/common_events.lua"
pattern = '''            elseif _c.name == 'The Family' then loc_vars = {localize(_c.unlock_condition.extra, 'poker_hands')}'''
position = "after"
payload = '''            elseif _c.name == 'The Quarrel' then loc_vars = {localize(_c.unlock_condition.extra, 'poker_hands')}
            elseif _c.name == 'Querent' then loc_vars = {_c.unlock_condition.extra}'''
match_indent = false



[[patches]]
[patches.pattern]
target = "functions/misc_functions.lua"
pattern = '''function find_joker(name, non_debuff)
  local jokers = {}
  if not G.jokers or not G.jokers.cards then return {} end
  for k, v in pairs(G.jokers.cards) do
    if v and type(v) == 'table' and v.ability.name == name and (non_debuff or not v.debuff) then
      table.insert(jokers, v)
    end
  end
  for k, v in pairs(G.consumeables.cards) do
    if v and type(v) == 'table' and v.ability.name == name and (non_debuff or not v.debuff) then
      table.insert(jokers, v)
    end
  end
  return jokers
end'''
position = "after"
payload = '''function just_destroy_cards(cards)
	for i=1, #cards do
		if cards[i].ability.name == 'Glass Card' then 
			cards[i]:shatter()
		else
			cards[i]:start_dissolve(nil, i == 1)
		end
	end
	for i=1, #G.jokers.cards do
		G.jokers.cards[i]:calculate_joker({remove_playing_cards = true, removed = cards})
	end
end'''
match_indent = false

# Pelter Jokers
[[patches]]
[patches.pattern]
target = "card.lua"
pattern = '''        elseif self.ability.name == 'Jolly Joker' or self.ability.name == 'Zany Joker' or
            self.ability.name == 'Mad Joker' or self.ability.name == 'Crazy Joker'  or 
            self.ability.name == 'Droll Joker' then 
            loc_vars = {self.ability.t_mult, localize(self.ability.type, 'poker_hands')}
        elseif self.ability.name == 'Sly Joker' or self.ability.name == 'Wily Joker' or
        self.ability.name == 'Clever Joker' or self.ability.name == 'Devious Joker'  or 
        self.ability.name == 'Crafty Joker' then 
            loc_vars = {self.ability.t_chips, localize(self.ability.type, 'poker_hands')}'''
position = "at"
payload = '''        elseif self.ability.name == 'Jolly Joker' or self.ability.name == 'Zany Joker' or
            self.ability.name == 'Mad Joker' or self.ability.name == 'Crazy Joker' or 
            self.ability.name == 'Ecstatic Joker' or self.ability.name == 'Droll Joker' then 
            loc_vars = {self.ability.t_mult, localize(self.ability.type, 'poker_hands')}
        elseif self.ability.name == 'Sly Joker' or self.ability.name == 'Wily Joker' or
        self.ability.name == 'Clever Joker' or self.ability.name == 'Devious Joker'  or 
        self.ability.name == 'Sinister Joker' or self.ability.name == 'Crafty Joker' then 
            loc_vars = {self.ability.t_chips, localize(self.ability.type, 'poker_hands')}'''
match_indent = false

# Silver
[[patches]]
[patches.pattern]
target = "card.lua"
pattern = '''    if self.ability.name == 'Talisman' or self.ability.name == 'Deja Vu' or self.ability.name == 'Trance' or self.ability.name == 'Medium' then
        local conv_card = G.hand.highlighted[1]
        G.E_MANAGER:add_event(Event({func = function()
            play_sound('tarot1')
            used_tarot:juice_up(0.3, 0.5)
            return true end }))
        
        G.E_MANAGER:add_event(Event({trigger = 'after',delay = 0.1,func = function()
            conv_card:set_seal(self.ability.extra, nil, true)
            return true end }))
        
        delay(0.5)
        G.E_MANAGER:add_event(Event({trigger = 'after', delay = 0.2,func = function() G.hand:unhighlight_all(); return true end }))
    end'''
position = "at"
payload = '''    if self.ability.name == 'Talisman' or self.ability.name == 'Deja Vu' or self.ability.name == 'Trance' or self.ability.name == 'Medium' or self.ability.name == 'Replicate' then
        local conv_card = G.hand.highlighted[1]
        G.E_MANAGER:add_event(Event({func = function()
            play_sound('tarot1')
            used_tarot:juice_up(0.3, 0.5)
            return true end }))
        
        G.E_MANAGER:add_event(Event({trigger = 'after',delay = 0.1,func = function()
            conv_card:set_seal(self.ability.extra, nil, true)
            return true end }))
        
        delay(0.5)
        G.E_MANAGER:add_event(Event({trigger = 'after', delay = 0.2,func = function() G.hand:unhighlight_all(); return true end }))
    end'''
match_indent = false

